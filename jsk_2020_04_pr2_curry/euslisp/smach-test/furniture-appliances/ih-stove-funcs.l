(defun curry-state-ask ()
  (warn "Please check. Is it going well? ~%")
  (setq ans (read))
  (format t "Your answer is ~A. ~%" ans)
  (if (eql ans 'yes) :success :fail)
  )

(defun string-cb (msg)
  (setq *msg* msg)
  (setq *data* (send msg :data))
  (format t "data is ~A ~%" *data*)
  (setq *msg-flag* t)
  )


(defun init ()
  (ros::roseus "smach-shelf-funcs" :anonymous t)
  (ros::load-ros-manifest "roseus")
  (ros::subscribe "smach_state_msg" std_msgs::string #'string-cb 1)
  (warn "init! ~%")
  )

(defun off ()
  (warn "state: off ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (if (equal *data* "on") ;; case文使って書いても良いかも
      (return-from off :on))
  (if (equal *data* "finish")
      (return-from off :finish)
    (off)
    )
  )

(defun on ()
  (warn "state: on ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  ;; (if (equal *data* "off")
  ;;     (return-from on :off))
  ;; (if (equal *data* "finish")
  ;;     (return-from on :finish))
  ;; (if (equal *data* "melting-fire")
  ;;     (return-from on :melting-fire))
  ;; (if (equal *data* "low-heat")
  ;;     (return-from on :low-heat))
  ;; (if (equal *data* "medium-heat")
  ;;     (return-from on :medium-heat))
  ;; (if (equal *data* "high-heat")
  ;;     (return-from on :high-heat))
  ;; (if (equal *data* "high-power")
  ;;     (return-from on :high-power)
  ;;   (on)
  ;;   )

  (cond
   ((equal *data* "off")
    (return-from on :off))
   ((equal *data* "finish")
    (return-from on :finish))
   ((equal *data* "melting-fire")
      (return-from on :melting-fire))
   ((equal *data* "low-heat")
    (return-from on :low-heat))
   ((equal *data* "medium-heat")
    (return-from on :medium-heat))
   ((equal *data* "high-heat")
    (return-from on :high-heat))
   ((equal *data* "high-power")
    (return-from on :high-power))
   )
  (on)
  )

(defun melting-fire ()
  (warn "state: melting-fire ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (cond
   ((equal *data* "off")
    (return-from melting-fire :off))
   ((equal *data* "low-heat")
    (return-from melting-fire :low-heat))
   ((equal *data* "medium-heat")
    (return-from melting-fire :medium-heat))
   ((equal *data* "high-heat")
    (return-from melting-fire :high-heat))
   ((equal *data* "high-power")
    (return-from melting-fire :high-power))
   )
  (melting-fire)

  ;; (if (equal *data* "off")
  ;;     (return-from melting-fire :off))
  ;; (if (equal *data* "finish")
  ;;     (return-from melting-fire :finish)
  ;;   (melting-fire)
  ;;   )
  )

(defun low-heat ()
  (warn "state: low-heat ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (cond
   ((equal *data* "off")
    (return-from low-heat :off))
   ((equal *data* "melting-fire")
    (return-from low-heat :melting-fire))
   ((equal *data* "medium-heat")
    (return-from low-heat :medium-heat))
   ((equal *data* "high-heat")
    (return-from low-heat :high-heat))
   ((equal *data* "high-power")
    (return-from low-heat :high-power))
   )
  (low-heat)
  )

(defun medium-heat ()
  (warn "state: medium-heat ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (cond
   ((equal *data* "off")
    (return-from medium-heat :off))
   ((equal *data* "melting-fire")
    (return-from medium-heat :melting-fire))
   ((equal *data* "low-heat")
    (return-from medium-heat :low-heat))
   ((equal *data* "high-heat")
    (return-from medium-heat :high-heat))
   ((equal *data* "high-power")
    (return-from medium-heat :high-power))
   )
  (medium-heat)
  )

(defun high-heat ()
  (warn "state: high-heat ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (cond
   ((equal *data* "off")
    (return-from high-heat :off))
   ((equal *data* "melting-fire")
    (return-from high-heat :melting-fire))
   ((equal *data* "low-heat")
    (return-from high-heat :low-heat))
   ((equal *data* "medium-heat")
    (return-from high-heat :medium-heat))
   ((equal *data* "high-power")
    (return-from high-heat :high-power))
   )
  (high-heat)
  )

(defun high-power ()
  (warn "state: high-power ~%")
  (setq *msg-flag* nil)
  (until *msg-flag*
         (ros::spin-once)
         (ros::sleep)
         )
  (cond
   ((equal *data* "off")
    (return-from high-power :off))
   ((equal *data* "melting-fire")
    (return-from high-power :melting-fire))
   ((equal *data* "low-heat")
    (return-from high-power :low-heat))
   ((equal *data* "medium-heat")
    (return-from high-power :medium-heat))
   ((equal *data* "high-heat")
    (return-from high-power :high-heat))
   )
  (high-power)
  )

